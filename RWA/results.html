<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Search Results</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://kit.fontawesome.com/e3d5ef4e0a.js" crossorigin="anonymous"></script>
</head>

<body>
    <style>
        body {
            background-color: #eee;
        }
    </style>

    <div class="loading">
        <div class="spinner"></div>
    </div>

    <div class="nav-wrapper" id="nav">
        <div class="apartment-dropdown" id="apartment-dropdown"></div>
        <nav>
            <div class="nav-logo">
                <svg width="150" viewBox="0 0 582 308" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path style="animation-delay: 2s;" fill-rule="evenodd" clip-rule="evenodd"
                        d="M207.798 66.25L142.282 132.5L150.891 132.808L159.5 133.116L180.359 111.808C191.832 100.089 217.582 74.061 237.582 53.97L273.946 17.44L331.72 75.22L389.494 133H398.491H407.487L377.744 103.244L348 73.488V53.744V34H341.5H335V47.244V60.488L304.744 30.244C288.103 13.61 274.224 0 273.901 0C273.578 0 243.832 29.813 207.798 66.25ZM0 224.431V307H8.5H17V232.5V158L38.75 158.006C50.713 158.009 63.149 158.445 66.387 158.976C74.361 160.282 83.628 164.812 88.647 169.859C102.052 183.339 101.748 208.543 88.025 221.38C78.39 230.392 69.822 233 49.844 233C38.694 233 36.869 233.217 37.357 234.488C37.671 235.307 50.207 251.954 65.214 271.483L92.5 306.989L102.75 306.995C108.387 306.998 113 306.762 113 306.471C113 306.181 110.65 302.918 107.779 299.221C77.093 259.718 68.083 247.674 68.596 246.844C68.929 246.307 69.409 246.075 69.663 246.33C70.633 247.3 82.282 243.887 88.2 240.899C95.243 237.344 105.068 228.444 108.599 222.42C113.764 213.61 115.281 207.322 115.336 194.5C115.381 184.195 115.056 181.653 113.038 176.5C108.115 163.934 100.375 155.395 88.684 149.632C75.056 142.914 73.265 142.668 34.75 142.244L0 141.861V224.431ZM168 142.631C168 143.494 176.128 172.29 188.709 216C194.487 236.075 202.704 264.65 206.968 279.5L214.722 306.5L226.284 306.781C236.646 307.033 237.901 306.877 238.384 305.281C239.092 302.939 265.273 205.432 269.924 187.815C271.911 180.288 273.774 173.893 274.063 173.604C274.352 173.315 276.543 180.373 278.931 189.289C281.32 198.205 284.732 210.9 286.513 217.5C289.711 229.352 306.806 291.546 309.678 301.782L311.161 307.064L322.263 306.782L333.366 306.5L341.097 280.5C345.349 266.2 354.252 235.825 360.882 213C367.512 190.175 374.75 165.461 376.968 158.081C379.186 150.7 381 144.045 381 143.292C381 142.216 379.154 141.984 372.399 142.211L363.799 142.5L344.07 211.5C333.218 249.45 323.996 281.85 323.574 283.5L322.808 286.5L321.479 283C320.748 281.075 316.548 266.675 312.146 251C307.744 235.325 300.093 208.1 295.144 190.5C290.195 172.9 285.138 154.77 283.905 150.211L281.665 141.922L274.145 142.211L266.625 142.5L265.439 147C262.628 157.662 229.79 276.158 227.75 283L226.408 287.5L224.618 281C222.73 274.142 216.765 252.839 209.499 227C207.102 218.475 202.673 202.725 199.657 192C196.641 181.275 192.272 165.637 189.948 157.25L185.723 142H176.861C171.988 142 168 142.284 168 142.631ZM481.233 163.25C472.053 184.571 459.649 213.217 435.008 270C427.728 286.775 421.143 301.962 420.373 303.75L418.973 307H428.336H437.699L442.457 295.75C445.074 289.563 450.378 277.188 454.243 268.25L461.271 252H500.402H539.533L551.184 279.25L562.834 306.5L572.365 306.786L581.897 307.071L574.342 289.786C570.188 280.279 563.75 265.525 560.036 257C556.323 248.475 543.943 220.125 532.526 194C521.109 167.875 511.381 145.488 510.909 144.25C510.098 142.127 509.492 142 500.216 142H490.383L481.233 163.25ZM501 160.958C501 161.485 508.018 178.247 516.595 198.208C525.172 218.169 532.42 235.063 532.702 235.75C533.105 236.735 526.221 237 500.216 237H467.218L477.913 211.75C483.796 197.863 491.059 180.547 494.055 173.272C498.857 161.607 501 157.807 501 160.958Z"
                        fill="black" />
                </svg>
            </div>
            <div class="nav-links">
                <div class="nav-item">
                    <a href="index.html">Homepage</a>
                </div>
                <div class="nav-item" id="apartment-dropdown-hover">
                    <a href="#">Apartments <i class="fa-solid fa-chevron-down"></i></a>
                </div>
                <div class="nav-item" id="house-dropdown-hover">
                    <a href="#">Houses <i class="fa-solid fa-chevron-down"></i></a>
                </div>
                <div class="nav-item">
                    <a href="#" id="contact">Contact RWA</a>
                </div>
            </div>

            <div class="nav-item">
                <a href="liked.html">My Liked Listings<i class="fa-solid fa-heart" style="margin-left: 10px;"></i></a>
            </div>
        </nav>
    </div>

    <div class="hero">

        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
            <h1
                style="font-size: 30px; font-weight: 400; font-family: Montserrat; margin-top: 0; text-shadow: none; color: #242424;">
                Homes in Cyprus</h1>
            <i class="fa-solid fa-bars" style="color: #242424; font-size: 20px;"></i>
        </div>

        <div class="searchbar" style="position: static;">
            <div class="input">
                <i class="fa-solid fa-location-crosshairs"></i>
                <input type="text" placeholder="City" id="cityInput">
            </div>
            <div class="input">
                <i class="fa-solid fa-bed"></i>
                <input type="number" placeholder="Rooms" id="roomsInput">
            </div>
            <div class="input">
                <i class="fa-solid fa-tag"></i>
                <ul id="tagList"></ul>
                <input type="text" placeholder="Add tags..." id="tagsInput">
            </div>
            <div class="input">
                <i class="fa-solid fa-house"></i>
                <input type="text" placeholder="House/Apartment" id="typeInput">
            </div>
            <button class="animated-button" id="searchBtn">
                <svg viewBox="0 0 24 24" class="arr-2" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M16.1716 10.9999L10.8076 5.63589L12.2218 4.22168L20 11.9999L12.2218 19.778L10.8076 18.3638L16.1716 12.9999H4V10.9999H16.1716Z">
                    </path>
                </svg>
                <span class="text">Search RWA</span>
                <span class="circle"></span>
                <svg viewBox="0 0 24 24" class="arr-1" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M16.1716 10.9999L10.8076 5.63589L12.2218 4.22168L20 11.9999L12.2218 19.778L10.8076 18.3638L16.1716 12.9999H4V10.9999H16.1716Z">
                    </path>
                </svg>
            </button>
        </div>
    </div>

    <div style="width: 70%; margin: auto; align-items: center; margin-top: 20px;">
        <span id="resultsAmount"></span>
    </div>

    <div id="results"></div>

    <footer>
        <div class="newsletter">
            <div class="container">
                <h1>Lets find Harmony together.</h1>
                <div class="email-input">
                    <input type="text" placeholder="Your Email...">
                    <button>Submit</button>
                </div>
            </div>
        </div>
    </footer>

    <script>
        async function displayResults() {
            const params = new URLSearchParams(window.location.search);

            const city = params.get("city")?.toLowerCase() || "";
            const rooms = params.get("rooms") || "";
            const tags = params.get("tags")?.toLowerCase().split(",").map(t => t.trim()).filter(Boolean) || [];
            const type = params.get("type")?.toLowerCase() || "";

            document.getElementById("cityInput").value = params.get("city") || "";
            document.getElementById("roomsInput").value = params.get("rooms") || "";
            activeTags = tags;
            renderTags();
            tagsInput.value = "";

            const url = new URL(window.location.href);
            url.searchParams.delete("tags");
            window.history.replaceState({}, "", url);

            document.getElementById("typeInput").value = params.get("type") || "";

            const response = await fetch("apartments.json");
            if (!response.ok) {
                document.getElementById("results").innerHTML = "<p>Failed to load listings.json</p>";
                return;
            }
            const listings = await response.json();

            const filtered = listings.filter(item => {
                const matchesCity = !city || item.location.toLowerCase().includes(city);
                const matchesRooms = !rooms || item.bedrooms == rooms;
                const matchesTags = !tags.length || tags.every(tag => item.tags.map(t => t.toLowerCase()).includes(tag));
                const matchesType = !type || item.title.toLowerCase().includes(type);
                return matchesCity && matchesRooms && matchesTags && matchesType;
            });

            const resultsDiv = document.getElementById("results");
            resultsDiv.innerHTML = "";

            let resultsAmount = 0;

            const resultsAmountSpan = document.getElementById('resultsAmount');
            const uniqueCities = [...new Set(filtered.map(item => item.location))];

            let cityDisplay = "";
            if (uniqueCities.length > 0) {
                if (uniqueCities.length <= 2) {
                    cityDisplay = uniqueCities.join(", ");
                } else {
                    cityDisplay = `${uniqueCities[0]}, ${uniqueCities[1]}, +${uniqueCities.length - 2} more`;
                }
            }

            resultsAmountSpan.innerText =
                `Found ${filtered.length} result(s) ${cityDisplay ? " — " + cityDisplay : ""}`;

            if (filtered.length === 0) {
                resultsDiv.style.display = "flex";
                resultsDiv.style.justifyContent = "center";
                const noResultsImg = document.createElement('img');
                noResultsImg.src = 'imgs/no-results.png';
                noResultsImg.style.width = '400px';
                noResultsImg.style.textAlign = "center";
                resultsDiv.appendChild(noResultsImg);
                resultsDiv.style.marginTop = "50px";
            } else {
                filtered.forEach((item, index) => {
                    const div = document.createElement("div");
                    div.classList.add("result-item");
                    div.style.animationDelay = `${index * 0.2}s`;
                    div.setAttribute("data-id", item.id);
                    div.innerHTML = `
  <div style="width:100%;height:60%;overflow:hidden;margin-bottom:10px; border-radius: 10px;">
      <img src="${item.cover}" alt="${item.title}" style="width:100%;height:100%;object-fit:cover;">
  </div>
  <div style="min-width:0;">
      <h4 style="
          display:block;
          white-space:nowrap;
          overflow:hidden;
          text-overflow:ellipsis;
          margin:0 0 5px 0;
      ">${item.title}</h4>
  </div>
  <p style="font-size: 20px;">€${item.price.toLocaleString()}</p>
  <div class="result-item tags" style="display:grid;grid-template-columns:repeat(3,1fr);">
      <span style="font-size:12px;"><i class="fa-solid fa-bed" style="margin-right:10px;display:inline-block;"></i>${item.bedrooms} bed</span>
      <span style="font-size:12px;"><i class="fa-solid fa-bath" style="margin-right:10px;"></i>${item.bathrooms} bath</span>
      <span style="font-size:12px;"><i class="fa-solid fa-expand" style="margin-right:10px;"></i>${item.sqm} m²</span>
  </div>
  <p style="font-size: 14px; color: gray;"><i style="margin-right: 10px;" class="fa-solid fa-map-pin"></i> ${item.location}</p>
  `;
                    div.addEventListener("click", () => {
                        window.location.href = `details.html?id=${item.id}`;
                    });
                    div.style.animationDelay = `${index * 0.2}s`;
                    resultsDiv.appendChild(div);
                });



                if (filtered.length > 0 && activeTags.length > 0) {
                    document.getElementById("results").classList.add("move");
                } else {
                    document.getElementById("results").classList.remove("move");
                }
            }
        }

        const tagsInput = document.getElementById("tagsInput");
        const tagList = document.getElementById("tagList");

        let activeTags = [];

        function updateResultsMoveClass() {
            const resultsDiv = document.getElementById("results");

            if (activeTags.length > 0) {
                resultsDiv.classList.add("move");

                // calculate rows of tags (3 tags per row)
                const rows = Math.ceil(activeTags.length / 3);
                const tagHeight = 40; // height per tag row in px (adjust if needed)
                resultsDiv.style.marginTop = `${rows * tagHeight + 5}px`; // positive moves it down
            } else {
                resultsDiv.classList.remove("move");
                resultsDiv.style.marginTop = "30px";
            }
        }
        function addTag(tag) {
            tag = tag.toLowerCase();
            if (!tag || activeTags.includes(tag)) return;

            activeTags.push(tag);
            renderTags();
            tagsInput.value = "";

            updateResultsMoveClass(); // <- update class here
        }

        function removeTag(tag) {
            activeTags = activeTags.filter(t => t !== tag);
            renderTags();

            updateResultsMoveClass(); // <- and here
        }

        function renderTags() {
            tagList.innerHTML = "";
            activeTags.forEach(tag => {
                const li = document.createElement("li");
                li.classList.add("tag");
                li.innerHTML = `${tag}<span onclick="removeTag('${tag}')">×</span>`;
                tagList.appendChild(li);
            });
        }

        // Add on Enter
        tagsInput.addEventListener("keypress", e => {
            if (e.key === "Enter") {
                e.preventDefault();
                addTag(tagsInput.value.trim());
            }
        });

        document.getElementById("searchBtn").addEventListener("click", () => {
            const city = document.getElementById("cityInput").value.trim();
            const rooms = document.getElementById("roomsInput").value.trim();
            const type = document.getElementById("typeInput").value.trim();

            const url = new URL(window.location.href);
            url.searchParams.set("city", city);
            url.searchParams.set("rooms", rooms);
            url.searchParams.set("type", type);

            if (activeTags.length > 0) {
                url.searchParams.set("tags", activeTags.join(","));
            } else {
                url.searchParams.delete("tags");
            }

            window.location.href = url.toString();
        });

        window.onload = displayResults;



    </script>
</body>

</html>